<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Classifica√ß√£o - Tempo Regressivo</title>
    <script src="https://unpkg.com/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
            transition: all 0.3s ease;
        }

        .item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .item.expired {
            border-left-color: #f56565;
            background: #fff5f5;
        }

        .position {
            font-weight: bold;
            color: #4299e1;
            min-width: 40px;
            font-size: 1.2rem;
        }

        .name {
            flex-grow: 1;
            margin: 0 15px;
            font-weight: 500;
        }

        .time-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 120px;
        }

        .score {
            font-weight: bold;
            color: #48bb78;
            font-size: 1.1rem;
        }

        .remaining-time {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 5px;
        }

        .remaining-time.warning {
            color: #ed8936;
            font-weight: bold;
        }

        .remaining-time.danger {
            color: #f56565;
            font-weight: bold;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .form-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        button {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            cursor: pointer;
            font-weight: 600;
            border: none;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.3);
        }

        button:active {
            transform: translateY(0);
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            button:hover {
                transform: none;
                box-shadow: none;
            }
            
            .item:hover {
                transform: none;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            
            button:active {
                background: #3182ce;
                transform: scale(0.98);
            }
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-add {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .btn-remove {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #f7fafc;
            border-radius: 6px;
            border-left: 3px solid #4299e1;
        }

        .empty-state {
            text-align: center;
            color: #718096;
            font-style: italic;
            padding: 40px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .mobile-menu-toggle {
            display: none;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            width: 100%;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.2);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f7fafc;
            border: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: #4299e1;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8rem;
                line-height: 1.2;
            }
            
            .header p {
                font-size: 0.9rem;
                margin-bottom: 15px;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .card h2 {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .tabs {
                display: none;
                flex-direction: column;
                margin-bottom: 15px;
                text-align: left;
            }
            
            .tabs.show {
                display: flex;
            }
            
            .tab {
                padding: 12px 15px;
                font-size: 0.9rem;
                margin-bottom: 2px;
                text-align: left;
                color: #333;
                background: #f7fafc;
                border-left: 4px solid #4299e1;
            }
            
            .tab.active {
                background: #4299e1;
                color: white;
                border-left-color: #3182ce;
            }
            
            .item {
                padding: 12px;
                margin: 8px 0;
                flex-direction: column;
                align-items: flex-start;
            }
            
            .item .position {
                font-size: 1.1rem;
                margin-bottom: 5px;
            }
            
            .item .name {
                margin: 5px 0;
                font-size: 1rem;
            }
            
            .time-display {
                align-items: flex-start;
                margin-top: 8px;
            }
            
            .score {
                font-size: 1rem;
            }
            
            .remaining-time {
                font-size: 0.85rem;
            }
            
            .form-section {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            input, select, button {
                padding: 10px;
                font-size: 0.95rem;
            }
            
            button {
                margin-top: 8px;
                padding: 12px;
            }
            
            .button-group {
                flex-direction: column;
                gap: 8px;
            }
            
            .history-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }
            
            .empty-state {
                padding: 20px;
                font-size: 0.9rem;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .card {
                padding: 10px;
            }
            
            .card h2 {
                font-size: 1.2rem;
            }
            
            .tab {
                padding: 10px 12px;
                font-size: 0.85rem;
                text-align: left;
                color: #333;
                background: #f7fafc;
                border-left: 4px solid #4299e1;
            }
            
            .tab.active {
                background: #4299e1;
                color: white;
                border-left-color: #3182ce;
            }
            
            .item {
                padding: 10px;
            }
            
            .form-section {
                padding: 10px;
            }
            
            input, select, button {
                padding: 8px;
                font-size: 0.9rem;
            }
        }
        
        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .tabs {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                font-size: 0.8rem;
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Sistema de Classifica√ß√£o - Tempo Regressivo</h1>
            <p>Controle de tempo em tempo real para participantes</p>
        </div>
        
        <div id="connectionStatus" class="status disconnected">
            Desconectado do servidor
        </div>

        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
            üì± Menu de Navega√ß√£o
        </button>
        
        <div class="tabs" id="tabsMenu">
            <button class="tab active" onclick="showTab('classification')">üìä Classifica√ß√£o</button>
            <button class="tab" onclick="showTab('teams')">üë• Equipes</button>
            <button class="tab" onclick="showTab('participants')">üë§ Participantes</button>
            <button class="tab" onclick="showTab('time-management')">‚è∞ Gerenciar Tempo</button>
            <button class="tab" onclick="showTab('history')">üìà Hist√≥rico</button>
        </div>

        <!-- Tab: Classifica√ß√£o -->
        <div id="classification" class="tab-content active">
            <div class="grid">
                <div class="card">
                    <h2>üèÜ Classifica√ß√£o das Equipes</h2>
                    <div id="teamsList"></div>
                </div>

                <div class="card">
                    <h2>üë• Classifica√ß√£o dos Participantes</h2>
                    <div id="participantsList"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Equipes -->
        <div id="teams" class="tab-content">
            <div class="form-section">
                <h2>‚ûï Criar Nova Equipe</h2>
                <div class="form-group">
                    <label>Nome da Equipe:</label>
                    <input type="text" id="teamName" placeholder="Ex: Equipe Alpha" />
                </div>
                <button onclick="createTeam()">Criar Equipe</button>
            </div>

            <div class="card">
                <h2>üìã Lista de Equipes</h2>
                <div id="teamsManagementList"></div>
            </div>
        </div>

        <!-- Tab: Participantes -->
        <div id="participants" class="tab-content">
            <div class="form-section">
                <h2>‚ûï Criar Novo Participante</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome do Participante:</label>
                        <input type="text" id="participantName" placeholder="Ex: Jo√£o Silva" />
                    </div>
                    <div class="form-group">
                        <label>Equipe:</label>
                        <select id="participantTeamId">
                            <option value="">Selecione uma equipe</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tempo Inicial (HH:MM:SS):</label>
                        <input type="text" id="participantInitialTime" placeholder="01:30:00 (m√°x: 99:59:59)" />
                    </div>
                </div>
                <button onclick="createParticipant()">Criar Participante</button>
            </div>

            <div class="card">
                <h2>üìã Lista de Participantes</h2>
                <div id="participantsManagementList"></div>
            </div>
        </div>

        <!-- Tab: Gerenciar Tempo -->
        <div id="time-management" class="tab-content">
            <div class="form-section">
                <h2>‚è∞ Adicionar/Remover Tempo do Participante</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Participante:</label>
                        <select id="timeParticipantId">
                            <option value="">Selecione um participante</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tempo (HH:MM:SS):</label>
                        <input type="text" id="timeAmount" placeholder="00:30:00 (m√°x: 99:59:59)" />
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o:</label>
                        <input type="text" id="timeDescription" placeholder="Ex: Trabalho realizado" />
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-add" onclick="addTimeToParticipant()">‚ûï Adicionar Tempo</button>
                    <button class="btn-remove" onclick="removeTimeFromParticipant()">‚ûñ Remover Tempo</button>
                </div>
            </div>

            <div class="card">
                <h2>üìã Participantes com Tempo Restante</h2>
                <div id="timeParticipantsList"></div>
            </div>
        </div>

        <!-- Tab: Hist√≥rico -->
        <div id="history" class="tab-content">
            <div class="form-section">
                <h2>üìà Consultar Hist√≥rico</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tipo:</label>
                        <select id="historyType" onchange="updateHistoryDropdowns()">
                            <option value="participant">Participante</option>
                            <option value="team">Equipe</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label id="historyLabel">Participante:</label>
                        <select id="historyDropdown">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                </div>
                <button onclick="getHistory()">Consultar Hist√≥rico</button>
            </div>

            <div class="card">
                <h2>üìã Hist√≥rico</h2>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <script>
        let connection = null;
        let currentClassification = null;
        let updateInterval = null;
        let participantsTimerInfo = [];
        let teamsList = [];
        let participantsList = [];

        // Conectar ao SignalR
        async function startConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/classificationHub")
                .build();

            connection.on("ReceiveClassification", async function (classification) {
                currentClassification = classification;
                await updateManagementLists(classification);
                updateClassificationDisplay(classification);
            });

            connection.on("TimeUpdate", function (serverTime) {
                updateTimersLocally();
            });

            connection.on("ParticipantsExpired", function (expiredParticipantIds) {
                showExpiredParticipantsNotification(expiredParticipantIds);
            });

            try {
                await connection.start();
                document.getElementById("connectionStatus").textContent = "‚úÖ Conectado ao servidor";
                document.getElementById("connectionStatus").className = "status connected";
                
                // Obter classifica√ß√£o inicial
                await connection.invoke("GetCurrentClassification");
                
                // Obter informa√ß√µes de timer dos participantes
                await loadParticipantsTimerInfo();
                
                // Carregar listas para dropdowns
                await loadTeamsAndParticipantsLists();
                
                // Iniciar atualiza√ß√£o autom√°tica do tempo
                startTimeUpdate();
            } catch (err) {
                document.getElementById("connectionStatus").textContent = "‚ùå Erro de conex√£o: " + err.toString();
                document.getElementById("connectionStatus").className = "status disconnected";
            }
        }

        // Carregar informa√ß√µes de timer dos participantes
        async function loadParticipantsTimerInfo() {
            try {
                const response = await fetch('/api/classification/participants/timer-info');
                if (response.ok) {
                    participantsTimerInfo = await response.json();
                    console.log('Informa√ß√µes de timer carregadas:', participantsTimerInfo);
                } else {
                    console.error('Erro ao carregar informa√ß√µes de timer:', response.statusText);
                    participantsTimerInfo = [];
                }
            } catch (error) {
                console.error('Erro ao carregar informa√ß√µes de timer:', error);
                participantsTimerInfo = [];
            }
        }

        // Carregar listas de equipes e participantes para dropdowns
        async function loadTeamsAndParticipantsLists() {
            try {
                // Carregar equipes
                const teamsResponse = await fetch('/api/classification/teams/list');
                if (teamsResponse.ok) {
                    teamsList = await teamsResponse.json();
                    console.log('Lista de equipes carregada:', teamsList);
                }

                // Carregar participantes
                const participantsResponse = await fetch('/api/classification/participants/list');
                if (participantsResponse.ok) {
                    participantsList = await participantsResponse.json();
                    console.log('Lista de participantes carregada:', participantsList);
                }

                // Atualizar dropdowns do hist√≥rico
                updateHistoryDropdowns();
            } catch (error) {
                console.error('Erro ao carregar listas:', error);
            }
        }

        // Atualizar dropdowns do hist√≥rico baseado no tipo selecionado
        function updateHistoryDropdowns() {
            const type = document.getElementById("historyType").value;
            const dropdown = document.getElementById("historyDropdown");
            const label = document.getElementById("historyLabel");
            
            dropdown.innerHTML = '<option value="">Selecione...</option>';
            
            if (type === 'team') {
                label.textContent = 'Equipe:';
                teamsList.forEach(team => {
                    const option = document.createElement("option");
                    option.value = team.id;
                    option.textContent = team.name;
                    dropdown.appendChild(option);
                });
            } else {
                label.textContent = 'Participante:';
                participantsList.forEach(participant => {
                    const option = document.createElement("option");
                    option.value = participant.id;
                    option.textContent = `${participant.name} (${participant.teamName})`;
                    dropdown.appendChild(option);
                });
            }
        }

        // Iniciar atualiza√ß√£o autom√°tica do tempo
        function startTimeUpdate() {
            if (updateInterval) clearInterval(updateInterval);
            
            updateInterval = setInterval(async () => {
                updateTimersLocally();
                
                // Recarregar informa√ß√µes de timer a cada 10 segundos para capturar mudan√ßas mais rapidamente
                if (Math.floor(Date.now() / 1000) % 10 === 0) {
                    await loadParticipantsTimerInfo();
                }
            }, 1000);
        }

        // Atualizar timers localmente
        function updateTimersLocally() {
            if (!currentClassification || !participantsTimerInfo.length) return;

            const now = new Date();
            let hasChanges = false;

            // Atualizar tempos restantes dos participantes
            for (let participant of currentClassification.participants) {
                const timerInfo = participantsTimerInfo.find(p => p.participantId === participant.id);
                if (timerInfo && timerInfo.startTime) {
                    const startTime = new Date(timerInfo.startTime);
                    const elapsedMs = now.getTime() - startTime.getTime();
                    const initialTimeMs = parseTimeToMs(timerInfo.initialTime);
                    const remainingMs = Math.max(0, initialTimeMs - elapsedMs);
                    
                    const newRemainingTime = formatMsToTime(remainingMs);
                    
                    if (participant.remainingTime !== newRemainingTime) {
                        participant.remainingTime = newRemainingTime;
                        hasChanges = true;
                    }
                }
            }

            // Calcular tempo restante das equipes (soma dos participantes)
            for (let team of currentClassification.teams) {
                const teamParticipants = currentClassification.participants.filter(p => p.teamId === team.id);
                let totalRemainingMs = 0;

                for (let participant of teamParticipants) {
                    const timerInfo = participantsTimerInfo.find(p => p.participantId === participant.id);
                    if (timerInfo && timerInfo.startTime) {
                        const startTime = new Date(timerInfo.startTime);
                        const elapsedMs = now.getTime() - startTime.getTime();
                        const initialTimeMs = parseTimeToMs(timerInfo.initialTime);
                        const remainingMs = Math.max(0, initialTimeMs - elapsedMs);
                        totalRemainingMs += remainingMs;
                    }
                }

                const newTeamRemainingTime = formatMsToTime(totalRemainingMs);
                
                if (team.remainingTime !== newTeamRemainingTime) {
                    team.remainingTime = newTeamRemainingTime;
                    hasChanges = true;
                }
            }

            if (hasChanges) {
                updateClassificationDisplay(currentClassification);
                updateTimeManagementList(currentClassification);
            }
        }

        // Converter tempo HH:MM:SS para milissegundos
        function parseTimeToMs(timeStr) {
            const parts = timeStr.split(':');
            const hours = parseInt(parts[0]) || 0;
            const minutes = parseInt(parts[1]) || 0;
            const seconds = parseInt(parts[2]) || 0;
            
            // Permitir at√© 99 horas para evitar overflow muito grande
            const validHours = Math.min(hours, 99);
            const validMinutes = Math.min(minutes, 59);
            const validSeconds = Math.min(seconds, 59);
            
            return (validHours * 3600 + validMinutes * 60 + validSeconds) * 1000;
        }

        // Converter milissegundos para formato HH:MM:SS
        function formatMsToTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            // Permitir at√© 99 horas na exibi√ß√£o
            const displayHours = Math.min(hours, 99);
            
            return `${displayHours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Validar formato de tempo HH:MM:SS
        function isValidTimeFormat(timeStr) {
            const timeRegex = /^(\d{1,2}):([0-5]?\d):([0-5]?\d)$/;
            const match = timeStr.match(timeRegex);
            
            if (!match) return false;
            
            const hours = parseInt(match[1]);
            const minutes = parseInt(match[2]);
            const seconds = parseInt(match[3]);
            
            // Validar limites - permitir at√© 99 horas
            return hours >= 0 && hours <= 99 && 
                   minutes >= 0 && minutes <= 59 && 
                   seconds >= 0 && seconds <= 59;
        }

        // Mostrar notifica√ß√£o de participantes expirados
        function showExpiredParticipantsNotification(expiredParticipantIds) {
            const expiredNames = [];
            for (let participant of currentClassification.participants) {
                if (expiredParticipantIds.includes(participant.id)) {
                    expiredNames.push(participant.name);
                }
            }
            
            if (expiredNames.length > 0) {
                alert(`‚è∞ Tempo expirado para: ${expiredNames.join(', ')}`);
            }
        }

        // Atualizar exibi√ß√£o da classifica√ß√£o
        function updateClassificationDisplay(classification) {
            // Atualizar equipes
            const teamsList = document.getElementById("teamsList");
            teamsList.innerHTML = "";
            
            if (classification.teams.length === 0) {
                teamsList.innerHTML = '<div class="empty-state">Nenhuma equipe cadastrada</div>';
            } else {
                classification.teams.forEach(team => {
                    const teamDiv = document.createElement("div");
                    teamDiv.className = `item ${team.remainingTime === "00:00:00" ? 'expired' : ''}`;
                    
                    const remainingTimeClass = getTimeClass(team.remainingTime);
                    
                    teamDiv.innerHTML = `
                        <span class="position">#${team.position}</span>
                        <span class="name">${team.name}</span>
                        <div class="time-display">
                            <span class="remaining-time ${remainingTimeClass}">‚è±Ô∏è ${team.remainingTime}</span>
                        </div>
                    `;
                    teamsList.appendChild(teamDiv);
                });
            }

            // Atualizar participantes
            const participantsList = document.getElementById("participantsList");
            participantsList.innerHTML = "";
            
            if (classification.participants.length === 0) {
                participantsList.innerHTML = '<div class="empty-state">Nenhum participante cadastrado</div>';
            } else {
                classification.participants.forEach(participant => {
                    const participantDiv = document.createElement("div");
                    participantDiv.className = `item ${participant.remainingTime === "00:00:00" ? 'expired' : ''}`;
                    
                    const remainingTimeClass = getTimeClass(participant.remainingTime);
                    
                    participantDiv.innerHTML = `
                        <span class="position">#${participant.position}</span>
                        <span class="name">${participant.name} (${participant.teamName})</span>
                        <div class="time-display">
                            <span class="remaining-time ${remainingTimeClass}">‚è±Ô∏è ${participant.remainingTime}</span>
                        </div>
                    `;
                    participantsList.appendChild(participantDiv);
                });
            }
        }

        // Atualizar lista de participantes na tela de gerenciar tempo
        function updateTimeManagementList(classification) {
            const timeParticipantsList = document.getElementById("timeParticipantsList");
            if (!timeParticipantsList) return; // Se n√£o estiver na aba de gerenciar tempo, n√£o fazer nada
            
            timeParticipantsList.innerHTML = "";
            
            if (classification.participants.length === 0) {
                timeParticipantsList.innerHTML = '<div class="empty-state">Nenhum participante cadastrado</div>';
            } else {
                classification.participants.forEach(participant => {
                    const participantDiv = document.createElement("div");
                    participantDiv.className = `item ${participant.remainingTime === "00:00:00" ? 'expired' : ''}`;
                    
                    const remainingTimeClass = getTimeClass(participant.remainingTime);
                    
                    participantDiv.innerHTML = `
                        <span class="name">${participant.name} (${participant.teamName})</span>
                        <div class="time-display">
                            <span class="remaining-time ${remainingTimeClass}">‚è±Ô∏è ${participant.remainingTime}</span>
                        </div>
                    `;
                    timeParticipantsList.appendChild(participantDiv);
                });
            }
        }

        // Atualizar listas de gerenciamento
        async function updateManagementLists(classification) {
            // Recarregar informa√ß√µes de timer se necess√°rio
            await loadParticipantsTimerInfo();
            
            // Recarregar listas para dropdowns se necess√°rio
            await loadTeamsAndParticipantsLists();
            
            // Atualizar lista de participantes na tela de gerenciar tempo
            updateTimeManagementList(classification);
            
            // Atualizar lista de equipes para gerenciamento
            const teamsManagementList = document.getElementById("teamsManagementList");
            teamsManagementList.innerHTML = "";
            
            if (classification.teams.length === 0) {
                teamsManagementList.innerHTML = '<div class="empty-state">Nenhuma equipe cadastrada</div>';
            } else {
                classification.teams.forEach(team => {
                    const teamDiv = document.createElement("div");
                    teamDiv.className = "item";
                    teamDiv.innerHTML = `
                        <span class="name">${team.name}</span>
                        <div class="time-display">
                            <span class="remaining-time">‚è±Ô∏è ${team.remainingTime}</span>
                        </div>
                        <button class="btn-danger" onclick="deleteTeam(${team.id})">üóëÔ∏è Remover</button>
                    `;
                    teamsManagementList.appendChild(teamDiv);
                });
            }

            // Atualizar lista de participantes para gerenciamento
            const participantsManagementList = document.getElementById("participantsManagementList");
            participantsManagementList.innerHTML = "";
            
            if (classification.participants.length === 0) {
                participantsManagementList.innerHTML = '<div class="empty-state">Nenhum participante cadastrado</div>';
            } else {
                classification.participants.forEach(participant => {
                    const participantDiv = document.createElement("div");
                    participantDiv.className = "item";
                    participantDiv.innerHTML = `
                        <span class="name">${participant.name} (${participant.teamName})</span>
                        <div class="time-display">
                            <span class="remaining-time">‚è±Ô∏è ${participant.remainingTime}</span>
                        </div>
                        <button class="btn-danger" onclick="deleteParticipant(${participant.id})">üóëÔ∏è Remover</button>
                    `;
                    participantsManagementList.appendChild(participantDiv);
                });
            }

            // Atualizar select de equipes
            const teamSelect = document.getElementById("participantTeamId");
            teamSelect.innerHTML = '<option value="">Selecione uma equipe</option>';
            classification.teams.forEach(team => {
                const option = document.createElement("option");
                option.value = team.id;
                option.textContent = team.name;
                teamSelect.appendChild(option);
            });

            // Atualizar select de participantes para gerenciamento de tempo
            const timeParticipantSelect = document.getElementById("timeParticipantId");
            timeParticipantSelect.innerHTML = '<option value="">Selecione um participante</option>';
            classification.participants.forEach(participant => {
                const option = document.createElement("option");
                option.value = participant.id;
                option.textContent = `${participant.name} (${participant.teamName})`;
                timeParticipantSelect.appendChild(option);
            });

        }

        // Determinar classe CSS baseada no tempo restante
        function getTimeClass(remainingTime) {
            const timeParts = remainingTime.split(':');
            const totalMinutes = parseInt(timeParts[0]) * 60 + parseInt(timeParts[1]);
            
            if (totalMinutes <= 0) return 'danger';
            if (totalMinutes <= 5) return 'warning';
            return '';
        }

        // Criar equipe
        async function createTeam() {
            const name = document.getElementById("teamName").value;

            if (!name) {
                alert("Preencha o nome da equipe!");
                return;
            }

            try {
                const response = await fetch('/api/classification/teams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                if (response.ok) {
                    alert("Equipe criada com sucesso!");
                    document.getElementById("teamName").value = "";
                } else {
                    alert("Erro ao criar equipe!");
                }
            } catch (error) {
                alert("Erro: " + error.message);
            }
        }

        // Criar participante
        async function createParticipant() {
            const name = document.getElementById("participantName").value;
            const teamId = document.getElementById("participantTeamId").value;
            const initialTime = document.getElementById("participantInitialTime").value;

            if (!name || !teamId || !initialTime) {
                alert("Preencha todos os campos!");
                return;
            }

            // Validar formato de tempo
            if (!isValidTimeFormat(initialTime)) {
                alert("Formato de tempo inv√°lido! Use HH:MM:SS (m√°ximo 99:59:59)");
                return;
            }

            try {
                const response = await fetch('/api/classification/participants', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, teamId: parseInt(teamId), initialTime })
                });

                if (response.ok) {
                    alert("Participante criado com sucesso!");
                    document.getElementById("participantName").value = "";
                    document.getElementById("participantTeamId").value = "";
                    document.getElementById("participantInitialTime").value = "";
                } else {
                    alert("Erro ao criar participante!");
                }
            } catch (error) {
                alert("Erro: " + error.message);
            }
        }

        // Adicionar tempo ao participante
        async function addTimeToParticipant() {
            const participantId = document.getElementById("timeParticipantId").value;
            const timeAmount = document.getElementById("timeAmount").value;
            const description = document.getElementById("timeDescription").value;

            if (!participantId || !timeAmount || !description) {
                alert("Preencha todos os campos!");
                return;
            }

            // Validar formato de tempo
            if (!isValidTimeFormat(timeAmount)) {
                alert("Formato de tempo inv√°lido! Use HH:MM:SS (m√°ximo 99:59:59)");
                return;
            }

            try {
                const response = await fetch(`/api/classification/participants/${participantId}/score`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scoreChange: timeAmount,
                        description: description,
                        actionType: "AddScore"
                    })
                });

                if (response.ok) {
                    alert("Tempo adicionado com sucesso!");
                    document.getElementById("timeAmount").value = "";
                    document.getElementById("timeDescription").value = "";
                    
                    // Recarregar informa√ß√µes de timer para sincronizar
                    await loadParticipantsTimerInfo();
                } else {
                    alert("Erro ao adicionar tempo!");
                }
            } catch (error) {
                alert("Erro: " + error.message);
            }
        }

        // Remover tempo do participante
        async function removeTimeFromParticipant() {
            const participantId = document.getElementById("timeParticipantId").value;
            const timeAmount = document.getElementById("timeAmount").value;
            const description = document.getElementById("timeDescription").value;

            if (!participantId || !timeAmount || !description) {
                alert("Preencha todos os campos!");
                return;
            }

            // Validar formato de tempo
            if (!isValidTimeFormat(timeAmount)) {
                alert("Formato de tempo inv√°lido! Use HH:MM:SS (m√°ximo 99:59:59)");
                return;
            }

            try {
                const response = await fetch(`/api/classification/participants/${participantId}/score`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scoreChange: timeAmount,
                        description: description,
                        actionType: "RemoveScore"
                    })
                });

                if (response.ok) {
                    alert("Tempo removido com sucesso!");
                    document.getElementById("timeAmount").value = "";
                    document.getElementById("timeDescription").value = "";
                    
                    // Recarregar informa√ß√µes de timer para sincronizar
                    await loadParticipantsTimerInfo();
                } else {
                    alert("Erro ao remover tempo!");
                }
            } catch (error) {
                alert("Erro: " + error.message);
            }
        }

        // Deletar equipe
        async function deleteTeam(teamId) {
            if (!confirm("Tem certeza que deseja remover esta equipe?")) return;

            try {
                const response = await fetch(`/api/classification/teams/${teamId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert("Equipe removida com sucesso!");
                } else {
                    alert("Erro ao remover equipe!");
                }
            } catch (error) {
                alert("Erro: " + error.message);
            }
        }

        // Deletar participante
        async function deleteParticipant(participantId) {
            if (!confirm("Tem certeza que deseja remover este participante?")) return;

            try {
                const response = await fetch(`/api/classification/participants/${participantId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert("Participante removido com sucesso!");
                } else {
                    alert("Erro ao remover participante!");
                }
            } catch (error) {
                alert("Erro: " + error.message);
            }
        }

        // Obter hist√≥rico
        async function getHistory() {
            const type = document.getElementById("historyType").value;
            const selectedId = document.getElementById("historyDropdown").value;
            
            if (!selectedId) {
                alert("Selecione um item da lista!");
                return;
            }

            try {
                const endpoint = type === 'team' 
                    ? `/api/classification/teams/${selectedId}/history`
                    : `/api/classification/participants/${selectedId}/history`;
                
                const response = await fetch(endpoint);
                const history = await response.json();
                
                const historyList = document.getElementById("historyList");
                historyList.innerHTML = "";
                
                if (history.length === 0) {
                    historyList.innerHTML = '<div class="empty-state">Nenhum hist√≥rico encontrado.</div>';
                    return;
                }

                history.forEach(item => {
                    const historyDiv = document.createElement("div");
                    historyDiv.className = "history-item";
                    
                    // Determinar o sinal da mudan√ßa
                    const isPositive = item.scoreChange.startsWith('+') || !item.scoreChange.startsWith('-');
                    const changeClass = isPositive ? 'score' : 'btn-remove';
                    
                    historyDiv.innerHTML = `
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${item.description}</div>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${item.teamName ? `Equipe: ${item.teamName}` : ''}
                                ${item.participantName ? `Participante: ${item.participantName}` : ''}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="${changeClass}" style="font-weight: bold; margin-bottom: 5px;">
                                ${isPositive ? '+' : ''}${item.scoreChange}
                            </div>
                            <div style="font-size: 0.8rem; color: #999;">
                                ${item.actionType}
                            </div>
                            <div style="font-size: 0.8rem; color: #999;">
                                ${new Date(item.timestamp).toLocaleString()}
                            </div>
                        </div>
                    `;
                    historyList.appendChild(historyDiv);
                });
            } catch (error) {
                alert("Erro ao obter hist√≥rico: " + error.message);
            }
        }

        // Controle de abas
        function showTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar aba selecionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Fechar menu mobile ap√≥s sele√ß√£o
            if (window.innerWidth <= 768) {
                document.getElementById('tabsMenu').classList.remove('show');
            }
        }
        
        // Controle do menu mobile
        function toggleMobileMenu() {
            const tabsMenu = document.getElementById('tabsMenu');
            tabsMenu.classList.toggle('show');
        }

        // Iniciar conex√£o quando a p√°gina carregar
        window.onload = startConnection;
    </script>
</body>
</html>